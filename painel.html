<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<title>Gerador de Painel com Encaixe Jigsaw</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root {
  --bg: #121212;
  --card: #1e1e1e;
  --text: #e0e0e0;
  --accent: #2196f3;
  --border: #333;
}
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 16px;
}
h1 { font-size: 22px; margin-bottom: 12px; }
.panel {
  background: var(--card);
  padding: 16px;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.5);
  max-width: 600px;
  width: 100%;
  margin-bottom: 20px;
}
label { font-weight: 600; display: block; margin-top: 10px; }
input, select, button {
  width: 100%;
  padding: 10px;
  margin-top: 4px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: #2a2a2a;
  color: var(--text);
}
button {
  background: var(--accent);
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  border: none;
  transition: opacity 0.3s;
}
button:disabled { opacity: 0; cursor: default; pointer-events: none; }
.row { display: flex; gap: 10px; flex-wrap: wrap; }
.row > div { flex: 1; min-width: 120px; }
.btns { display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; }
</style>
</head>
<body>

<div class="panel">
  <h1>Gerador de Painel com Encaixe Jigsaw</h1>
  <label>Imagem do painel:</label>
  <input id="file" type="file" accept="image/*">

  <label>Orientação da página:</label>
  <select id="orient">
    <option value="portrait">Vertical (A4 retrato)</option>
    <option value="landscape">Horizontal (A4 paisagem)</option>
  </select>

  <label>Divisão em partes:</label>
  <select id="preset">
    <option value="1x2">2 (1 × 2)</option>
    <option value="2x2">4 (2 × 2)</option>
    <option value="2x3">6 (2 × 3)</option>
    <option value="3x3">9 (3 × 3)</option>
    <option value="3x4">12 (3 × 4)</option>
    <option value="custom">Personalizar...</option>
  </select>

  <div id="customGrid" style="display:none;" class="row">
    <div>
      <label>Linhas:</label>
      <input id="rows" type="number" min="1" value="2">
    </div>
    <div>
      <label>Colunas:</label>
      <input id="cols" type="number" min="1" value="2">
    </div>
  </div>

  <label>Tamanho da aba (mm):</label>
  <input id="tabMm" type="number" min="0" value="10">

  <label>Tamanho da marca de corte (mm):</label>
  <input id="markMm" type="number" min="2" value="6">

  <div class="btns">
    <button id="gen" disabled>Gerar PDF</button>
    <button id="print" disabled>Imprimir</button>
    <button id="download" disabled>Baixar PDF</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const { jsPDF } = window.jspdf;
const MM_TO_PX = mm => mm * (96/25.4);
let sourceImage = null;
let generatedPages = [];

const fileInput = document.getElementById('file');
const genBtn = document.getElementById('gen');
const printBtn = document.getElementById('print');
const downloadBtn = document.getElementById('download');

function resetButtons(){
  genBtn.disabled = !sourceImage;
  printBtn.disabled = true;
  downloadBtn.disabled = true;
}

fileInput.addEventListener('change', async e=>{
  const file = e.target.files[0];
  if(file){
    sourceImage = await loadImage(file);
    if(sourceImage.naturalWidth > sourceImage.naturalHeight){
      document.getElementById('orient').value = "landscape";
    } else {
      document.getElementById('orient').value = "portrait";
    }
    resetButtons();
  }
});

function loadImage(file){
  return new Promise((res, rej)=>{
    const img = new Image();
    img.onload = ()=>res(img);
    img.onerror = rej;
    img.src = URL.createObjectURL(file);
  });
}

document.getElementById('preset').addEventListener('change', e=>{
  document.getElementById('customGrid').style.display = 
    (e.target.value === 'custom') ? 'flex' : 'none';
});

function generatePages(){
  if(!sourceImage) return;

  const orient = document.getElementById('orient').value;
  const pageWmm = orient === "portrait" ? 210 : 297;
  const pageHmm = orient === "portrait" ? 297 : 210;
  const pageW = Math.round(MM_TO_PX(pageWmm));
  const pageH = Math.round(MM_TO_PX(pageHmm));

  let rows, cols;
  const preset = document.getElementById('preset').value;
  if(preset !== "custom"){
    [rows, cols] = preset.split("x").map(Number);
  } else {
    rows = parseInt(document.getElementById('rows').value);
    cols = parseInt(document.getElementById('cols').value);
  }

  const tabPx = MM_TO_PX(parseFloat(document.getElementById('tabMm').value));
  const markPx = MM_TO_PX(parseFloat(document.getElementById('markMm').value));

  const sliceWsrc = sourceImage.naturalWidth / cols;
  const sliceHsrc = sourceImage.naturalHeight / rows;

  generatedPages = [];

  for(let r=0; r<rows; r++){
    for(let c=0; c<cols; c++){
      const canvas = document.createElement('canvas');
      canvas.width = pageW;
      canvas.height = pageH;
      const ctx = canvas.getContext('2d');

      ctx.fillStyle="#fff"; ctx.fillRect(0,0,pageW,pageH);

      let availW = pageW - ((c < cols-1) ? tabPx : 0);
      let availH = pageH - ((r < rows-1) ? tabPx : 0);
      const sliceAspect = sliceWsrc/sliceHsrc;
      let drawW = availW, drawH = availW/sliceAspect;
      if(drawH>availH){ drawH=availH; drawW=drawH*sliceAspect; }

      const dx = (pageW - ((c < cols-1) ? tabPx : 0) - drawW)/2;
      const dy = (pageH - ((r < rows-1) ? tabPx : 0) - drawH)/2;

      ctx.drawImage(sourceImage,
        c*sliceWsrc, r*sliceHsrc, sliceWsrc, sliceHsrc,
        dx, dy, drawW, drawH);

      ctx.strokeStyle="#000"; ctx.lineWidth=1.5;
      ctx.setLineDash([]);
      ctx.strokeRect(dx,dy,drawW,drawH);

      function drawJigsaw(x, y, w, h, horizontal=true){
        const radius = tabPx/2;
        ctx.strokeStyle="#000";
        ctx.lineWidth = 1.5;
        ctx.beginPath();
        if(horizontal){
          ctx.moveTo(x, y);
          ctx.lineTo(x+w/4, y);
          ctx.arc(x+w/2, y-radius/2, radius, Math.PI, 0, true);
          ctx.lineTo(x+3*w/4, y);
          ctx.lineTo(x+w, y);
          ctx.stroke();

          ctx.save();
          ctx.translate(x + w/2, y - radius/2 - radius/4);
          ctx.rotate(-Math.PI/2);
          ctx.font = `${radius/1.8}px Arial`;
          ctx.fillStyle = "#000";
          ctx.textAlign = "center";
          ctx.fillText("COLE AQUI", 0, 0);
          ctx.restore();
        } else {
          ctx.moveTo(x, y);
          ctx.lineTo(x, y+h/4);
          ctx.arc(x+radius/2, y+h/2, radius, -Math.PI/2, Math.PI/2, true);
          ctx.lineTo(x, y+3*h/4);
          ctx.lineTo(x, y+h);
          ctx.stroke();

          ctx.save();
          ctx.translate(x + radius/2 + radius/4, y + h/2);
          ctx.rotate(0);
          ctx.font = `${radius/1.8}px Arial`;
          ctx.fillStyle = "#000";
          ctx.textAlign = "center";
          ctx.fillText("COLE AQUI", 0, 0);
          ctx.restore();
        }
      }

      if(c<cols-1 && tabPx>0){ drawJigsaw(dx+drawW, dy, drawW, drawH, true); }
      if(r<rows-1 && tabPx>0){ drawJigsaw(dx, dy+drawH, drawW, drawH, false); }

      ctx.strokeStyle="#000"; ctx.lineWidth=1.2;
      ctx.beginPath();
      ctx.moveTo(dx-markPx,dy); ctx.lineTo(dx,dy);
      ctx.moveTo(dx,dy-markPx); ctx.lineTo(dx,dy);
      ctx.moveTo(dx+drawW+markPx,dy); ctx.lineTo(dx+drawW,dy);
      ctx.moveTo(dx+drawW,dy-markPx); ctx.lineTo(dx+drawW,dy);
      ctx.moveTo(dx-markPx,dy+drawH); ctx.lineTo(dx,dy+drawH);
      ctx.moveTo(dx,dy+drawH+markPx); ctx.lineTo(dx,dy+drawH);
      ctx.moveTo(dx+drawW+markPx,dy+drawH); ctx.lineTo(dx+drawW,dy+drawH);
      ctx.moveTo(dx+drawW,dy+drawH+markPx); ctx.lineTo(dx+drawW,dy+drawH);
      ctx.stroke();

      generatedPages.push({canvas,pageWmm,pageHmm});
    }
  }

  printBtn.disabled = false;
  downloadBtn.disabled = false;
  genBtn.disabled = true;
}

genBtn.addEventListener('click', generatePages);

printBtn.addEventListener('click', ()=>{
  if(generatedPages.length === 0) return;
  const w = generatedPages[0].pageWmm;
  const h = generatedPages[0].pageHmm;
  const pdf = new jsPDF({orientation: w>h?"landscape":"portrait", unit:"mm", format:[w,h]});
  generatedPages.forEach((pg,i)=>{
    const img = pg.canvas.toDataURL("image/jpeg",1.0);
    if(i>0) pdf.addPage([pg.pageWmm,pg.pageHmm], w>h?"landscape":"portrait");
    pdf.addImage(img,"JPEG",0,0,pg.pageWmm,pg.pageHmm);
  });
  pdf.autoPrint();
  window.open(pdf.output("bloburl"),"_blank");
});

downloadBtn.addEventListener('click', async ()=>{
  if(generatedPages.length === 0) return;
  const w = generatedPages[0].pageWmm;
  const h = generatedPages[0].pageHmm;
  const pdf = new jsPDF({orientation: w>h?"landscape":"portrait", unit:"mm", format:[w,h]});
  generatedPages.forEach((pg,i)=>{
    const img = pg.canvas.toDataURL("image/jpeg",1.0);
    if(i>0) pdf.addPage([pg.pageWmm,pg.pageHmm], w>h?"landscape":"portrait");
    pdf.addImage(img,"JPEG",0,0,pg.pageWmm,pg.pageHmm);
  });

  if(navigator.canShare && navigator.canShare({files:[new File([pdf.output("blob")],"painel.pdf",{type:"application/pdf"})]})){
    const file = new File([pdf.output("blob")], "painel.pdf", {type:"application/pdf"});
    await navigator.share({files:[file], title:"Painel", text:"Aqui está seu PDF do painel"});
  } else {
    pdf.save("painel.pdf");
  }
});
</script>
</body>
</html>
