<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<title>Gerador de Painel para Imprimir e Colar</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root {
    --paper-w: 210mm; /* A4 */
    --paper-h: 297mm;
  }
  body {
    margin: 0;
    font-family: system-ui, sans-serif;
    background: #f0f0f0;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 16px;
  }
  h1 { font-size: 20px; margin-bottom: 8px; }
  .panel {
    background: #fff;
    padding: 16px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    max-width: 800px;
    width: 100%;
    margin-bottom: 20px;
  }
  label { font-weight: 600; display: block; margin-top: 10px; }
  input, select, button {
    width: 100%;
    padding: 8px;
    margin-top: 4px;
    border: 1px solid #ccc;
    border-radius: 6px;
  }
  button {
    background: #0a66c2;
    color: #fff;
    font-weight: bold;
    border: none;
    cursor: pointer;
  }
  button:disabled { opacity: .6; cursor: not-allowed; }
  .row { display: flex; gap: 10px; }
  .row > div { flex: 1; }
  .preview {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 12px;
  }
  .page {
    width: var(--paper-w);
    height: var(--paper-h);
    background: #fff;
    border: 1px dashed #aaa;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }
  .page canvas { width: 100%; height: auto; }
  @media print {
    @page { size: A4; margin: 0 }
    body { background: #fff; padding: 0; }
    .panel { display: none; }
    .preview { grid-template-columns: 1fr; }
    .page { border: none; break-after: page; }
  }
</style>
</head>
<body>

<div class="panel">
  <h1>Gerador de Painel</h1>
  <label>Imagem do painel:</label>
  <input id="file" type="file" accept="image/*">

  <div class="row">
    <div>
      <label>Linhas:</label>
      <input id="rows" type="number" min="1" value="2">
    </div>
    <div>
      <label>Colunas:</label>
      <input id="cols" type="number" min="1" value="2">
    </div>
  </div>

  <label>Aba de cola (mm):</label>
  <input id="tabMm" type="number" min="0" value="10">

  <label>Tamanho da marca de corte (mm):</label>
  <input id="markMm" type="number" min="2" value="6">

  <button id="gen" disabled>Gerar páginas</button>
  <button id="print" disabled>Imprimir / Salvar PDF</button>
</div>

<div id="preview" class="preview"></div>

<script>
const MM_TO_PX = mm => mm * (96/25.4); // 96 dpi CSS

function loadImage(file){
  return new Promise((res, rej)=>{
    const img = new Image();
    img.onload = ()=>res(img);
    img.onerror = rej;
    img.src = URL.createObjectURL(file);
  });
}

let sourceImage = null;

document.getElementById('file').addEventListener('change', async e=>{
  const file = e.target.files[0];
  if(file){
    sourceImage = await loadImage(file);
    document.getElementById('gen').disabled = false;
  }
});

document.getElementById('gen').addEventListener('click', ()=>{
  if(!sourceImage) return;

  const rows = parseInt(document.getElementById('rows').value);
  const cols = parseInt(document.getElementById('cols').value);
  const tabPx = MM_TO_PX(parseFloat(document.getElementById('tabMm').value));
  const markPx = MM_TO_PX(parseFloat(document.getElementById('markMm').value));

  const pageW = Math.round(MM_TO_PX(210));
  const pageH = Math.round(MM_TO_PX(297));

  const sliceWsrc = sourceImage.naturalWidth / cols;
  const sliceHsrc = sourceImage.naturalHeight / rows;

  const preview = document.getElementById('preview');
  preview.innerHTML = '';

  for(let r=0; r<rows; r++){
    for(let c=0; c<cols; c++){
      const page = document.createElement('div');
      page.className = 'page';

      const canvas = document.createElement('canvas');
      canvas.width = pageW;
      canvas.height = pageH;
      const ctx = canvas.getContext('2d');

      // fundo branco
      ctx.fillStyle="#fff"; ctx.fillRect(0,0,canvas.width,canvas.height);

      // calcular tamanho máximo dentro da folha
      let availW = pageW - (c < cols-1 ? tabPx : 0);
      let availH = pageH - (r < rows-1 ? tabPx : 0);
      const sliceAspect = sliceWsrc/sliceHsrc;
      let drawW = availW, drawH = availW/sliceAspect;
      if(drawH>availH){ drawH=availH; drawW=drawH*sliceAspect; }

      const dx = (pageW - (c < cols-1 ? tabPx : 0) - drawW)/2;
      const dy = (pageH - (r < rows-1 ? tabPx : 0) - drawH)/2;

      // desenhar fatia da imagem
      ctx.drawImage(sourceImage,
        c*sliceWsrc, r*sliceHsrc, sliceWsrc, sliceHsrc,
        dx, dy, drawW, drawH);

      // desenhar moldura da peça
      ctx.strokeStyle="#000"; ctx.lineWidth=1; ctx.strokeRect(dx,dy,drawW,drawH);

      // desenhar abas
      if(c<cols-1 && tabPx>0){ // direita
        ctx.fillStyle="#fff"; ctx.fillRect(dx+drawW,dy,tabPx,drawH);
        ctx.strokeRect(dx+drawW,dy,tabPx,drawH);
      }
      if(r<rows-1 && tabPx>0){ // baixo
        ctx.fillStyle="#fff"; ctx.fillRect(dx,dy+drawH,drawW,tabPx);
        ctx.strokeRect(dx,dy+drawH,drawW,tabPx);
      }

      // marcas de corte nos cantos
      ctx.strokeStyle="#000"; ctx.lineWidth=1;
      ctx.beginPath();
      ctx.moveTo(dx-markPx,dy); ctx.lineTo(dx,dy);
      ctx.moveTo(dx,dy-markPx); ctx.lineTo(dx,dy);
      ctx.moveTo(dx+drawW+markPx,dy); ctx.lineTo(dx+drawW,dy);
      ctx.moveTo(dx+drawW,dy-markPx); ctx.lineTo(dx+drawW,dy);
      ctx.moveTo(dx-markPx,dy+drawH); ctx.lineTo(dx,dy+drawH);
      ctx.moveTo(dx,dy+drawH+markPx); ctx.lineTo(dx,dy+drawH);
      ctx.moveTo(dx+drawW+markPx,dy+drawH); ctx.lineTo(dx+drawW,dy+drawH);
      ctx.moveTo(dx+drawW,dy+drawH+markPx); ctx.lineTo(dx+drawW,dy+drawH);
      ctx.stroke();

      page.appendChild(canvas);
      preview.appendChild(page);
    }
  }

  document.getElementById('print').disabled = false;
});

document.getElementById('print').addEventListener('click', ()=>window.print());
</script>

</body>
</html>
