<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<title>Gerador de Painel para Imprimir e Colar</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  :root {
    --bg: #121212;
    --card: #1e1e1e;
    --text: #e0e0e0;
    --accent: #2196f3;
    --border: #333;
  }
  body {
    margin: 0;
    font-family: system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 16px;
  }
  h1 { font-size: 22px; margin-bottom: 12px; }
  .panel {
    background: var(--card);
    padding: 16px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.5);
    max-width: 800px;
    width: 100%;
    margin-bottom: 20px;
  }
  label { font-weight: 600; display: block; margin-top: 10px; }
  input, select, button {
    width: 100%;
    padding: 10px;
    margin-top: 4px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: #2a2a2a;
    color: var(--text);
  }
  button {
    background: var(--accent);
    color: #fff;
    font-weight: bold;
    cursor: pointer;
    border: none;
  }
  button:disabled { opacity: .5; cursor: not-allowed; }
  .row { display: flex; gap: 10px; flex-wrap: wrap; }
  .row > div { flex: 1; min-width: 120px; }
  .btns { display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; }
  .preview {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 12px;
  }
  .page {
    width: 210mm;
    height: 297mm;
    background: #fff;
    border: 1px dashed #555;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    position: relative;
  }
  .page canvas { width: 100%; height: auto; }
  @media print {
    @page { size: A4; margin: 0 }
    body { background: #fff; color: #000; padding: 0; }
    .panel { display: none; }
    .preview { grid-template-columns: 1fr; }
    .page { border: none; break-after: page; }
  }
</style>
</head>
<body>

<div class="panel">
  <h1>Gerador de Painel</h1>
  <label>Imagem do painel:</label>
  <input id="file" type="file" accept="image/*">

  <label>Orientação da página:</label>
  <select id="orient">
    <option value="portrait">Vertical (A4 retrato)</option>
    <option value="landscape">Horizontal (A4 paisagem)</option>
  </select>

  <label>Divisão em partes:</label>
  <select id="preset">
    <option value="1x2">2 (1 × 2)</option>
    <option value="2x2">4 (2 × 2)</option>
    <option value="2x3">6 (2 × 3)</option>
    <option value="3x3">9 (3 × 3)</option>
    <option value="3x4">12 (3 × 4)</option>
    <option value="custom">Personalizar...</option>
  </select>

  <div id="customGrid" style="display:none;" class="row">
    <div>
      <label>Linhas:</label>
      <input id="rows" type="number" min="1" value="2">
    </div>
    <div>
      <label>Colunas:</label>
      <input id="cols" type="number" min="1" value="2">
    </div>
  </div>

  <label>Aba de cola (mm):</label>
  <input id="tabMm" type="number" min="0" value="10">

  <label>Tamanho da marca de corte (mm):</label>
  <input id="markMm" type="number" min="2" value="6">

  <div class="btns">
    <button id="gen" disabled>Gerar páginas</button>
    <button id="print" disabled>Imprimir</button>
    <button id="download" disabled>Baixar PDF</button>
  </div>
</div>

<div id="preview" class="preview"></div>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
const { jsPDF } = window.jspdf;
const MM_TO_PX = mm => mm * (96/25.4); // 96 dpi CSS
function loadImage(file){
  return new Promise((res, rej)=>{
    const img = new Image();
    img.onload = ()=>res(img);
    img.onerror = rej;
    img.src = URL.createObjectURL(file);
  });
}

let sourceImage = null;
let generatedPages = [];

document.getElementById('file').addEventListener('change', async e=>{
  const file = e.target.files[0];
  if(file){
    sourceImage = await loadImage(file);
    document.getElementById('gen').disabled = false;
  }
});

document.getElementById('preset').addEventListener('change', e=>{
  document.getElementById('customGrid').style.display = 
    (e.target.value === 'custom') ? 'flex' : 'none';
});

document.getElementById('gen').addEventListener('click', ()=>{
  if(!sourceImage) return;

  const orient = document.getElementById('orient').value;
  let pageWmm = orient === "portrait" ? 210 : 297;
  let pageHmm = orient === "portrait" ? 297 : 210;
  const pageW = Math.round(MM_TO_PX(pageWmm));
  const pageH = Math.round(MM_TO_PX(pageHmm));

  let rows, cols;
  const preset = document.getElementById('preset').value;
  if(preset !== "custom"){
    [rows, cols] = preset.split("x").map(Number);
  } else {
    rows = parseInt(document.getElementById('rows').value);
    cols = parseInt(document.getElementById('cols').value);
  }

  const tabPx = MM_TO_PX(parseFloat(document.getElementById('tabMm').value));
  const markPx = MM_TO_PX(parseFloat(document.getElementById('markMm').value));

  const sliceWsrc = sourceImage.naturalWidth / cols;
  const sliceHsrc = sourceImage.naturalHeight / rows;

  const preview = document.getElementById('preview');
  preview.innerHTML = '';
  generatedPages = [];

  for(let r=0; r<rows; r++){
    for(let c=0; c<cols; c++){
      const canvas = document.createElement('canvas');
      canvas.width = pageW;
      canvas.height = pageH;
      const ctx = canvas.getContext('2d');

      ctx.fillStyle="#fff"; ctx.fillRect(0,0,pageW,pageH);

      let availW = pageW - ((c < cols-1) ? tabPx : 0);
      let availH = pageH - ((r < rows-1) ? tabPx : 0);
      const sliceAspect = sliceWsrc/sliceHsrc;
      let drawW = availW, drawH = availW/sliceAspect;
      if(drawH>availH){ drawH=availH; drawW=drawH*sliceAspect; }

      const dx = (pageW - ((c < cols-1) ? tabPx : 0) - drawW)/2;
      const dy = (pageH - ((r < rows-1) ? tabPx : 0) - drawH)/2;

      ctx.drawImage(sourceImage,
        c*sliceWsrc, r*sliceHsrc, sliceWsrc, sliceHsrc,
        dx, dy, drawW, drawH);

      // borda sólida
      ctx.strokeStyle="#000"; ctx.lineWidth=1.2;
      ctx.strokeRect(dx,dy,drawW,drawH);

      // aba direita
      if(c<cols-1 && tabPx>0){
        ctx.fillStyle="#fff"; ctx.fillRect(dx+drawW,dy,tabPx,drawH);
        ctx.strokeRect(dx+drawW,dy,tabPx,drawH);
        ctx.fillStyle="#000";
        ctx.font="12px sans-serif";
        ctx.save();
        ctx.translate(dx+drawW+tabPx/2, dy+drawH/2);
        ctx.rotate(-Math.PI/2);
        ctx.textAlign="center";
        ctx.fillText("Colar à peça da direita",0,0);
        ctx.restore();
      }

      // aba inferior
      if(r<rows-1 && tabPx>0){
        ctx.fillStyle="#fff"; ctx.fillRect(dx,dy+drawH,drawW,tabPx);
        ctx.strokeRect(dx,dy+drawH,drawW,tabPx);
        ctx.fillStyle="#000";
        ctx.font="12px sans-serif";
        ctx.textAlign="center";
        ctx.fillText("Colar à peça de baixo", dx+drawW/2, dy+drawH+tabPx/2+4);
      }

      // marcas de corte
      ctx.beginPath();
      ctx.moveTo(dx-markPx,dy); ctx.lineTo(dx,dy);
      ctx.moveTo(dx,dy-markPx); ctx.lineTo(dx,dy);
      ctx.moveTo(dx+drawW+markPx,dy); ctx.lineTo(dx+drawW,dy);
      ctx.moveTo(dx+drawW,dy-markPx); ctx.lineTo(dx+drawW,dy);
      ctx.moveTo(dx-markPx,dy+drawH); ctx.lineTo(dx,dy+drawH);
      ctx.moveTo(dx,dy+drawH+markPx); ctx.lineTo(dx,dy+drawH);
      ctx.moveTo(dx+drawW+markPx,dy+drawH); ctx.lineTo(dx+drawW,dy+drawH);
      ctx.moveTo(dx+drawW,dy+drawH+markPx); ctx.lineTo(dx+drawW,dy+drawH);
      ctx.stroke();

      const page = document.createElement('div');
      page.className = 'page';
      page.style.width = pageWmm+"mm";
      page.style.height = pageHmm+"mm";
      page.appendChild(canvas);
      preview.appendChild(page);

      generatedPages.push({canvas,pageWmm,pageHmm});
    }
  }

  document.getElementById('print').disabled = false;
  document.getElementById('download').disabled = false;
});

document.getElementById('print').addEventListener('click', ()=>window.print());

document.getElementById('download').addEventListener('click', ()=>{
  if(generatedPages.length === 0) return;
  const first = generatedPages[0];
  const pdf = new jsPDF({
    orientation: (first.pageWmm > first.pageHmm) ? "landscape" : "portrait",
    unit: "mm",
    format: [first.pageWmm, first.pageHmm]
  });
  generatedPages.forEach((pg,i)=>{
    const imgData = pg.canvas.toDataURL("image/jpeg",1.0);
    if(i>0) pdf.addPage([pg.pageWmm, pg.pageHmm], 
      (pg.pageWmm > pg.pageHmm) ? "landscape" : "portrait");
    pdf.addImage(imgData,"JPEG",0,0,pg.pageWmm,pg.pageHmm);
  });
  pdf.save("painel.pdf");
});
</script>

</body>
</html>
