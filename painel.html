<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="manifest" href="/painel/manifest.json">
<meta name="theme-color" content="#3367D6">
<link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="msapplication-TileColor" content="#3367D6">
<title>Gerador de Painel para Imprimir e Colar</title>
<link rel="stylesheet" href="/painel/style.css">
<style>
#preview-img {
  display: none;
  margin-top: 10px;
  width: 80px;
  height: 80px;
  object-fit: cover;
  border-radius: 8px;
  border: 2px solid var(--border);
  transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s;
  opacity: 0;
}
#preview-img.show {
  opacity: 1;
}
#preview-img:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}
</style>
</head>
<body>

<div class="container protected">
  <div class="panel">
    <h1>Gerador de Painel</h1>

    <div id="user-info" style="display:none;">
      <div>Usuário: <span class="name"></span></div>
      <div>Validade: <span class="validity"></span></div>
    </div>

    <label>Imagem do painel:</label>
    <div class="file-upload-wrapper">
      <input id="file" type="file" accept="image/*">
      <button type="button" class="file-upload-btn">Escolher Imagem</button>
      <span class="file-name">Nenhum arquivo selecionado</span>
      <img id="preview-img" src="" alt="Preview">
    </div>

    <label>Orientação da página:</label>
    <select id="orient">
      <option value="portrait">Vertical (A4 retrato)</option>
      <option value="landscape">Horizontal (A4 paisagem)</option>
    </select>

    <label>Divisão em partes:</label>
    <select id="preset">
      <option value="1x2">2 Folhas</option>
      <option value="2x2">4 Folhas</option>
      <option value="2x3">6 Folhas</option>
      <option value="3x3" selected>9 (3 × 3)</option>
      <option value="3x4">12 Folhas</option>
      <option value="custom">Personalizar...</option>
    </select>

    <div id="customGrid" style="display:none;" class="row">
      <div><label>Linhas:</label><input id="rows" type="number" min="1" value="2"></div>
      <div><label>Colunas:</label><input id="cols" type="number" min="1" value="2"></div>
    </div>

    <div class="btns">
      <button id="gen" disabled>Gerar PDF</button>
      <button id="print" style="display:none;">Imprimir</button>
      <button id="download" style="display:none;">Baixar PDF</button>
    </div>
  </div>
</div>

<div id="key-container">
  <label for="user-key">Cole sua KEY para acessar a página:</label><br>
  <input type="text" id="user-key"><br>
  <button id="submit-key">Acessar</button>
  <p id="key-message"></p>
</div>

<div id="whatsapp-btn" title="Fale conosco no WhatsApp">
  <img src="/icons/WhatsApp.svg" alt="WhatsApp">
</div>

<script src="painel/jspdf.umd.min.js"></script>
<script src="painel/script.js"></script>

<script>
document.addEventListener('gesturestart', e => e.preventDefault());
let lastTouchEnd = 0;
document.addEventListener('touchend', e => { const now=(new Date()).getTime(); if(now-lastTouchEnd<=300)e.preventDefault(); lastTouchEnd=now; });
document.body.addEventListener('touchmove', e=>{ e.preventDefault(); }, { passive:false });

if('serviceWorker' in navigator){
  window.addEventListener('load', ()=> navigator.serviceWorker.register('/painel/service-worker.js').catch(err=>console.warn(err)));
}

(function(){
  const content=document.querySelectorAll('.protected');
  content.forEach(c=>c.style.display='none');
  const container=document.getElementById('key-container');
  const userInfo=document.getElementById('user-info');
  const input=document.getElementById('user-key');
  let remainingMsGlobal=0;
  let userGlobal='';

  function base36Decode(str){
    const chars='0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    let result='';
    for(let i=0;i<str.length;i+=2){
      result+=String.fromCharCode(chars.indexOf(str[i])*36+chars.indexOf(str[i+1]));
    }
    return result;
  }

  async function sha1(msg){
    const buffer=new TextEncoder("utf-8").encode(msg);
    const hash=await crypto.subtle.digest("SHA-1", buffer);
    return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  async function verifyKey(key){
    const parts=key.split('-');
    if(parts.length!==2) return false;
    let payload;
    try{ payload=base36Decode(parts[0]); } catch(e){ return false; }
    const hash=await sha1(payload);
    if(hash.slice(0,8).toUpperCase()!==parts[1]) return false;
    const idx=payload.lastIndexOf(':');
    if(idx===-1) return false;
    const user=payload.slice(0,idx);
    const exp=parseFloat(payload.slice(idx+1));
    const now=Date.now();
    const remainingMs=exp<1e10? exp*60*1000 : exp-now;
    if(remainingMs<=0) return false;
    return {user, remainingMs};
  }

  function formatRemaining(ms){
    const s=Math.floor(ms/1000), m=Math.floor(s/60), h=Math.floor(m/60), d=Math.floor(h/24);
    const remH=h%24, remM=m%60, remS=s%60;
    if(d>=1) return d+' dias '+remH+'h '+remM+'m '+remS+'s restantes';
    if(h>=1) return h+'h '+remM+'m '+remS+'s restantes';
    if(m>=1) return m+'m '+remS+'s restantes';
    return s+'s restantes';
  }

  async function checkKey(key){
    const payload=await verifyKey(key);
    if(payload){
      content.forEach(c=>c.style.display='block');
      container.style.display='none';
      localStorage.setItem('user_key',key);
      remainingMsGlobal=payload.remainingMs;
      userGlobal=payload.user;
      userInfo.style.display='flex';
      userInfo.querySelector('.name').textContent=payload.user;
      userInfo.querySelector('.validity').textContent=formatRemaining(payload.remainingMs);
      startCountdown();
    } else{
      localStorage.removeItem('user_key');
      document.getElementById('key-message').innerText="KEY inválida ou expirada.";
    }
  }

  function startCountdown(){
    if(window.countdownInterval) clearInterval(window.countdownInterval);
    window.countdownInterval=setInterval(()=>{
      remainingMsGlobal-=1000;
      if(remainingMsGlobal<=0){
        clearInterval(window.countdownInterval);
        alert("Sua KEY expirou!");
        userInfo.style.display='none';
        content.forEach(c=>c.style.display='none');
        container.style.display='block';
        localStorage.removeItem('user_key');
      } else userInfo.querySelector('.validity').textContent=formatRemaining(remainingMsGlobal);
    },1000);
  }

  const storedKey=localStorage.getItem('user_key');
  if(storedKey) checkKey(storedKey);

  document.getElementById('submit-key').addEventListener('click', ()=>checkKey(input.value.trim()));
  input.addEventListener('keypress', e=>{ if(e.key==='Enter') checkKey(input.value.trim()); });

  const whatsappBtn=document.getElementById('whatsapp-btn');
  whatsappBtn.addEventListener('click', ()=> window.open('https://wa.me/5511998248013','_blank'));

  const fileInput = document.getElementById('file');
  const fileBtn = document.querySelector('.file-upload-btn');
  const fileName = document.querySelector('.file-name');
  const previewImg = document.getElementById('preview-img');
  const genBtn = document.getElementById('gen');
  const printBtn = document.getElementById('print');
  const downloadBtn = document.getElementById('download');

  fileBtn.addEventListener('click', () => fileInput.click());

  fileInput.addEventListener('change', () => {
    if (fileInput.files.length > 0) {
      const file = fileInput.files[0];
      fileName.textContent = file.name;
      const reader = new FileReader();
      reader.onload = e => {
        previewImg.src = e.target.result;
        previewImg.style.display = 'block';
        previewImg.classList.add('show');
      };
      reader.readAsDataURL(file);
      genBtn.disabled = false;
    } else {
      fileName.textContent = 'Nenhum arquivo selecionado';
      previewImg.style.display = 'none';
      previewImg.classList.remove('show');
      genBtn.disabled = true;
    }
  });

  function resetPDFButtons() {
    genBtn.style.display = 'inline-block';
    genBtn.disabled = fileInput.files.length === 0;
    printBtn.style.display = 'none';
    downloadBtn.style.display = 'none';
  }

  document.getElementById('rows').addEventListener('input', resetPDFButtons);
  document.getElementById('cols').addEventListener('input', resetPDFButtons);
  document.getElementById('preset').addEventListener('change', resetPDFButtons);
  document.getElementById('orient').addEventListener('change', resetPDFButtons);
})();
</script>

</body>
</html>