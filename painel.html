<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<title>Gerador de Painel para Imprimir e Colar</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  :root {
    --bg: #121212;
    --card: #1e1e1e;
    --text: #e0e0e0;
    --accent: #2196f3;
    --border: #333;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
    padding: 20px;
  }
  .container {
    width: 100%;
    max-width: 650px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  h1 { font-size: 26px; margin-bottom: 10px; text-align: center; }
  .panel {
    background: var(--card);
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  label { font-weight: 600; display: block; margin-bottom: 4px; }
  input, select, button {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: #2a2a2a;
    color: var(--text);
    font-size: 15px;
  }
  input[type="number"] { -moz-appearance:textfield; }
  input::-webkit-outer-spin-button,
  input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  button {
    background: var(--accent);
    color: #fff;
    font-weight: bold;
    cursor: pointer;
    border: none;
    transition: 0.2s;
  }
  button:hover { background: #1976d2; }
  button:disabled { opacity: 0.5; cursor: not-allowed; }
  .row { display: flex; gap: 10px; flex-wrap: wrap; }
  .row > div { flex: 1; min-width: 120px; }
  .btns { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-top: 10px; }
  small { opacity: 0.7; }

  /* Menu avançado melhorado */
  .advanced {
    border-top: 1px solid var(--border);
    padding-top: 12px;
    margin-top: 12px;
  }
  .advanced summary {
    cursor: pointer;
    font-weight: bold;
    list-style: none;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 0;
    font-size: 16px;
  }
  .advanced summary::-webkit-details-marker { display: none; }

  .advanced-content {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-top: 10px;
  }
  .advanced-content > div {
    flex: 1;
    min-width: 150px;
    display: flex;
    flex-direction: column;
  }
  .advanced-content label { margin-bottom: 6px; }
</style>
</head>
<body>

<div class="container">
  <div class="panel">
    <h1>Gerador de Painel</h1>

    <label>Imagem do painel:</label>
    <input id="file" type="file" accept="image/*">

    <label>Orientação da página:</label>
    <select id="orient">
      <option value="portrait">Vertical (A4 retrato)</option>
      <option value="landscape">Horizontal (A4 paisagem)</option>
    </select>
    <small>Ajuste automático pela imagem</small>

    <label>Divisão em partes:</label>
    <select id="preset">
      <option value="1x2">2 (1 × 2)</option>
      <option value="2x2">4 (2 × 2)</option>
      <option value="2x3">6 (2 × 3)</option>
      <option value="3x3">9 (3 × 3)</option>
      <option value="3x4">12 (3 × 4)</option>
      <option value="custom">Personalizar...</option>
    </select>

    <div id="customGrid" style="display:none;" class="row">
      <div>
        <label>Linhas:</label>
        <input id="rows" type="number" min="1" value="2">
      </div>
      <div>
        <label>Colunas:</label>
        <input id="cols" type="number" min="1" value="2">
      </div>
    </div>

    <details class="advanced">
      <summary>Opções Avançadas ▾</summary>
      <div class="advanced-content">
        <div>
          <label>Aba de cola (mm):</label>
          <input id="tabMm" type="number" min="0" value="10">
        </div>
        <div>
          <label>Tamanho da marca de corte (mm):</label>
          <input id="markMm" type="number" min="2" value="6">
        </div>
      </div>
    </details>

    <div class="btns">
      <button id="gen" disabled>Gerar PDF</button>
      <button id="print" style="display:none;">Imprimir</button>
      <button id="download" style="display:none;">Baixar PDF</button>
    </div>
  </div>
</div>

<script src="https://apolossh.github.io/jspdf.umd.min.js"></script>
<script>
const { jsPDF } = window.jspdf;
const MM_TO_PX = mm => mm * (96/25.4);

function loadImage(file){
  return new Promise((res, rej)=>{
    const img = new Image();
    img.onload = ()=>res(img);
    img.onerror = rej;
    img.src = URL.createObjectURL(file);
  });
}

let sourceImage = null;
let generatedPages = [];

const fileInput = document.getElementById('file');
const genBtn = document.getElementById('gen');
const printBtn = document.getElementById('print');
const downloadBtn = document.getElementById('download');

fileInput.addEventListener('change', async e=>{
  const file = e.target.files[0];
  if(file){
    sourceImage = await loadImage(file);
    document.getElementById('orient').value = sourceImage.naturalWidth > sourceImage.naturalHeight ? "landscape" : "portrait";
    genBtn.disabled = false;
    generatedPages = [];
    printBtn.style.display = 'none';
    downloadBtn.style.display = 'none';
    genBtn.style.display = 'inline-block';
  }
});

document.getElementById('preset').addEventListener('change', e=>{
  document.getElementById('customGrid').style.display = (e.target.value === 'custom') ? 'flex' : 'none';
});

genBtn.addEventListener('click', ()=>{
  if(!sourceImage) return;

  const orient = document.getElementById('orient').value;
  let pageWmm = orient === "portrait" ? 210 : 297;
  let pageHmm = orient === "portrait" ? 297 : 210;
  const pageW = Math.round(MM_TO_PX(pageWmm));
  const pageH = Math.round(MM_TO_PX(pageHmm));

  let rows, cols;
  const preset = document.getElementById('preset').value;
  if(preset !== "custom"){
    [rows, cols] = preset.split("x").map(Number);
  } else {
    rows = parseInt(document.getElementById('rows').value);
    cols = parseInt(document.getElementById('cols').value);
  }

  const tabPx = MM_TO_PX(parseFloat(document.getElementById('tabMm').value));
  const markPx = MM_TO_PX(parseFloat(document.getElementById('markMm').value));

  const sliceWsrc = sourceImage.naturalWidth / cols;
  const sliceHsrc = sourceImage.naturalHeight / rows;

  generatedPages = [];

  for(let r=0; r<rows; r++){
    for(let c=0; c<cols; c++){
      const canvas = document.createElement('canvas');
      canvas.width = pageW;
      canvas.height = pageH;
      const ctx = canvas.getContext('2d');

      ctx.fillStyle="#fff"; ctx.fillRect(0,0,pageW,pageH);

      let availW = pageW - ((c < cols-1) ? tabPx : 0);
      let availH = pageH - ((r < rows-1) ? tabPx : 0);
      const sliceAspect = sliceWsrc/sliceHsrc;
      let drawW = availW, drawH = availW/sliceAspect;
      if(drawH>availH){ drawH=availH; drawW=drawH*sliceAspect; }

      const dx = (pageW - ((c < cols-1) ? tabPx : 0) - drawW)/2;
      const dy = (pageH - ((r < rows-1) ? tabPx : 0) - drawH)/2;

      ctx.drawImage(sourceImage, c*sliceWsrc, r*sliceHsrc, sliceWsrc, sliceHsrc, dx, dy, drawW, drawH);

      ctx.strokeStyle="#000"; ctx.lineWidth=1.5; ctx.setLineDash([]); ctx.strokeRect(dx,dy,drawW,drawH);

      if(c<cols-1 && tabPx>0){
        ctx.fillStyle="#fff"; ctx.fillRect(dx+drawW,dy,tabPx,drawH);
        ctx.strokeStyle="#000"; ctx.strokeRect(dx+drawW,dy,tabPx,drawH);
        ctx.setLineDash([5,3]); ctx.beginPath(); ctx.moveTo(dx+drawW,dy); ctx.lineTo(dx+drawW,dy+drawH); ctx.stroke(); ctx.setLineDash([]);
        ctx.save(); ctx.translate(dx+drawW+tabPx/2, dy+drawH/2); ctx.rotate(-Math.PI/2); ctx.fillStyle="#000"; ctx.font="bold 18px sans-serif"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText("COLE AQUI",0,0); ctx.restore();
      }

      if(r<rows-1 && tabPx>0){
        ctx.fillStyle="#fff"; ctx.fillRect(dx,dy+drawH,drawW,tabPx);
        ctx.strokeStyle="#000"; ctx.strokeRect(dx,dy+drawH,drawW,tabPx);
        ctx.setLineDash([5,3]); ctx.beginPath(); ctx.moveTo(dx,dy+drawH); ctx.lineTo(dx+drawW,dy+drawH); ctx.stroke(); ctx.setLineDash([]);
        ctx.fillStyle="#000"; ctx.font="bold 18px sans-serif"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText("COLE AQUI", dx+drawW/2, dy+drawH+tabPx/2);
      }

      ctx.strokeStyle="#000"; ctx.lineWidth=1.2; ctx.beginPath();
      ctx.moveTo(dx-markPx,dy); ctx.lineTo(dx,dy); ctx.moveTo(dx,dy-markPx); ctx.lineTo(dx,dy);
      ctx.moveTo(dx+drawW+markPx,dy); ctx.lineTo(dx+drawW,dy); ctx.moveTo(dx+drawW,dy-markPx); ctx.lineTo(dx+drawW,dy);
      ctx.moveTo(dx-markPx,dy+drawH); ctx.lineTo(dx,dy+drawH); ctx.moveTo(dx,dy+drawH+markPx); ctx.lineTo(dx,dy+drawH);
      ctx.moveTo(dx+drawW+markPx,dy+drawH); ctx.lineTo(dx+drawW,dy+drawH); ctx.moveTo(dx+drawW,dy+drawH+markPx); ctx.lineTo(dx+drawW,dy+drawH);
      ctx.stroke();

      generatedPages.push({canvas,pageWmm,pageHmm, row: r, col: c});
    }
  }

  generatedPages.sort((a,b)=> a.row - b.row || a.col - b.col);

  genBtn.style.display = 'none';
  printBtn.style.display = 'inline-block';
  downloadBtn.style.display = 'inline-block';
});

function generatePDF(){
  if(generatedPages.length === 0) return null;
  const w = generatedPages[0].pageWmm;
  const h = generatedPages[0].pageHmm;
  const pdf = new jsPDF({orientation: w>h?"landscape":"portrait", unit:"mm", format:[w,h]});
  generatedPages.forEach((pg,i)=>{
    const img = pg.canvas.toDataURL("image/jpeg",1.0);
    if(i>0) pdf.addPage([pg.pageWmm,pg.pageHmm], w>h?"landscape":"portrait");
    pdf.addImage(img,"JPEG",0,0,pg.pageWmm,pg.pageHmm);
  });
  return pdf;
}

printBtn.addEventListener('click', ()=>{
  const pdf = generatePDF();
  if(pdf){
    pdf.autoPrint();
    window.open(pdf.output("bloburl"),"_blank");
  }
});

downloadBtn.addEventListener('click', async ()=>{
  const pdf = generatePDF();
  if(!pdf) return;

  const blob = pdf.output("blob");
  const file = new File([blob], "painel.pdf", {type:"application/pdf"});

  if(navigator.canShare && navigator.canShare({files:[file]})){
    try {
      await navigator.share({files:[file], title:"Painel PDF"});
    } catch(e){ console.log(e); }
  } else {
    const link = document.createElement('a');
    link.href = URL.createObjectURL(file);
    link.download = file.name;
    link.click();
    URL.revokeObjectURL(link.href);
  }
});
</script>
</body>
</html>
